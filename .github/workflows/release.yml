# è‡ªåŠ¨åŒ–å‘å¸ƒå·¥ä½œæµ
# å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒè·¨å¹³å°å¯æ‰§è¡Œæ–‡ä»¶

name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0ã€v1.2.3 ç­‰ç‰ˆæœ¬æ ‡ç­¾

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºrelease

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
    - name: Get version from tag
      id: get_version
      run: |
        echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: 'Cursor Tool Free ${{ steps.get_version.outputs.tag_name }}'
        body: |
          ðŸŽ‰ **Cursor Tool Free ${{ steps.get_version.outputs.tag_name }}** å‘å¸ƒï¼
          
          ## ðŸ“¦ ä¸‹è½½é“¾æŽ¥
          
          - ðŸªŸ **Windows**: CursorToolFree-Windows.exe
          - ðŸŽ **macOS (Apple Silicon)**: CursorToolFree-macOS-AppleSilicon.dmg
          - ðŸŽ **macOS (Intel)**: CursorToolFree-macOS-Intel.dmg
          - ðŸ§ **Linux**: CursorToolFree-Linux.AppImageï¼ˆåŒå‡»è¿è¡Œï¼Œé€šæ€æ‰€æœ‰Linuxå‘è¡Œç‰ˆï¼‰
          
          ## âœ¨ ä¸»è¦åŠŸèƒ½
          
          - ðŸ” ä¸“ä¸šçš„Cursorè´¦å·ç®¡ç†ç³»ç»Ÿ
          - ðŸ“± çŽ°ä»£åŒ–ç”¨æˆ·ç•Œé¢
          - ðŸŒ å®Œæ•´è·¨å¹³å°æ”¯æŒ
          - ðŸ›¡ï¸ è´¦å·å®‰å…¨ä¸Žéšç§ä¿æŠ¤
          - ðŸŒ æµè§ˆå™¨Cookieå¯¼å…¥æ”¯æŒ
          
          ## ðŸš€ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
          2. åŒå‡»è¿è¡Œï¼ˆé¦–æ¬¡å¯åŠ¨ä¼šè¦æ±‚è®¾ç½®Cursorè·¯å¾„ï¼‰
          3. å¼€å§‹ç®¡ç†ä½ çš„Cursorè´¦å·
          
          ---
          
          ðŸ’¡ å¦‚éœ€æºç å®‰è£…æˆ–äºŒæ¬¡å¼€å‘ï¼Œè¯·æŸ¥çœ‹ [README.md](https://github.com/QSXDY/cursor-tool-free#readme)
        draft: false
        prerelease: false

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --name "CursorToolFree" main.py --add-data "src;src" --add-data "resources;resources" --hidden-import PyQt6 --icon=icon.ico
    
    - name: Upload Windows executable
      run: |
        mv dist/CursorToolFree.exe dist/CursorToolFree-Windows.exe
        
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./dist/CursorToolFree-Windows.exe

  build-macos:
    needs: create-release
    strategy:
      matrix:
        include:
          - arch: arm64
            name: AppleSilicon
            runs-on: macos-latest
          - arch: x86_64
            name: Intel
            runs-on: macos-13  # ä½¿ç”¨ Intel æž„å»ºçŽ¯å¢ƒ
    runs-on: ${{ matrix.runs-on }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
    
    - name: Verify macOS icon
      run: |
        echo "âœ… ä½¿ç”¨é¡¹ç›®ä¸­çš„icon.icnsæ–‡ä»¶"
        ls -la icon.icns
        
    - name: Build macOS executable  
      run: |
        pyinstaller --onedir --windowed --name "CursorToolFree" main.py \
          --add-data "src:src" \
          --add-data "resources:resources" \
          --hidden-import PyQt6 \
          --icon=icon.icns \
          --osx-bundle-identifier com.cursor.toolfree
    
    - name: Create DMG
      run: |
        # å®‰è£…create-dmgå·¥å…·
        brew install create-dmg
        
        # åˆ›å»ºDMGæ–‡ä»¶
        create-dmg \
          --volname "Cursor Tool Free" \
          --volicon "icon.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "CursorToolFree.app" 150 200 \
          --hide-extension "CursorToolFree.app" \
          --app-drop-link 450 200 \
          "CursorToolFree-macOS-${{ matrix.name }}.dmg" \
          "dist/"
        
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./CursorToolFree-macOS-${{ matrix.name }}.dmg

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fuse
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
    
    - name: Build Linux AppImage
      run: |
        # ä½¿ç”¨ PyInstaller ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
        pyinstaller CursorToolFree.spec --clean --noconfirm
        
        # ä¸‹è½½ AppImage å·¥å…·
        wget -O appimagetool-x86_64.AppImage https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        
        # åˆ›å»º AppImage ç›®å½•ç»“æž„
        mkdir -p CursorToolFree.AppDir/usr/bin CursorToolFree.AppDir/usr/share/applications CursorToolFree.AppDir/usr/share/icons/hicolor/512x512/apps
        cp dist/CursorToolFree CursorToolFree.AppDir/usr/bin/
        cp -r resources CursorToolFree.AppDir/usr/share/
        cp icon.png CursorToolFree.AppDir/usr/share/icons/hicolor/512x512/apps/cursor-tool-free.png
        cp icon.png CursorToolFree.AppDir/cursor-tool-free.png
        
        # åˆ›å»º .desktop æ–‡ä»¶
        cat > CursorToolFree.AppDir/cursor-tool-free.desktop << 'DESKTOP_EOF'
        [Desktop Entry]
        Type=Application
        Name=Cursor Tool Free
        Comment=Cursorè´¦å·ç®¡ç†å·¥å…· - å…è´¹ç²¾ç®€ç‰ˆ
        Exec=CursorToolFree
        Icon=cursor-tool-free
        Categories=Development;
        Terminal=false
        StartupWMClass=CursorToolFree
        Keywords=cursor;account;manager;å¼€å‘;è´¦å·;ç®¡ç†;
        GenericName=Cursor Account Manager
        X-AppImage-Version=1.0.0
        DESKTOP_EOF
        
        # åˆ›å»º AppRun è„šæœ¬
        cat > CursorToolFree.AppDir/AppRun << 'APPRUN_EOF'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${0}")")"
        export QT_QPA_PLATFORM="${QT_QPA_PLATFORM:-xcb}"
        exec "${HERE}/usr/bin/CursorToolFree" "$@"
        APPRUN_EOF
        chmod +x CursorToolFree.AppDir/AppRun
        
        # å¤åˆ¶ .desktop æ–‡ä»¶å¹¶åˆ›å»º .DirIcon ç¬¦å·é“¾æŽ¥
        cp CursorToolFree.AppDir/cursor-tool-free.desktop CursorToolFree.AppDir/usr/share/applications/
        cd CursorToolFree.AppDir && ln -sf cursor-tool-free.png .DirIcon && cd ..
        
        # ç”Ÿæˆ AppImage
        ARCH=x86_64 ./appimagetool-x86_64.AppImage CursorToolFree.AppDir CursorToolFree-Linux.AppImage
    
    - name: Upload Linux AppImage
      run: |
        # AppImage å·²ç»æ˜¯æœ€ç»ˆæ–‡ä»¶ï¼Œæ— éœ€é‡å‘½å
        
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./CursorToolFree-Linux.AppImage
