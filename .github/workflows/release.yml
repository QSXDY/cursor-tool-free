# 自动化发布工作流
# 当推送版本标签时自动构建和发布跨平台可执行文件

name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # 匹配 v1.0.0、v1.2.3 等版本标签

permissions:
  contents: write  # 需要写权限来创建release

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
    - name: Get version from tag
      id: get_version
      run: |
        echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: 'Cursor Tool Free ${{ steps.get_version.outputs.tag_name }}'
        body: |
          🎉 **Cursor Tool Free ${{ steps.get_version.outputs.tag_name }}** 发布！
          
          ## 📦 下载链接
          
          - 🪟 **Windows**: CursorToolFree-Windows.exe
          - 🍎 **macOS**: CursorToolFree-macOS-Universal.dmg (支持Apple Silicon和Intel)
          - 🐧 **Linux**: CursorToolFree-Linux
          
          ## ✨ 主要功能
          
          - 🔐 专业的Cursor账号管理系统
          - 📱 现代化用户界面
          - 🌍 完整跨平台支持
          - 🛡️ 账号安全与隐私保护
          - 🌐 浏览器Cookie导入支持
          
          ## 🚀 快速开始
          
          1. 下载对应平台的可执行文件
          2. 双击运行（首次启动会要求设置Cursor路径）
          3. 开始管理你的Cursor账号
          
          ---
          
          💡 如需源码安装或二次开发，请查看 [README.md](https://github.com/QSXDY/cursor-tool-free#readme)
        draft: false
        prerelease: false

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --name "CursorToolFree" main.py --add-data "src;src" --add-data "resources;resources" --hidden-import PyQt6 --icon=icon.ico
    
    - name: Upload Windows executable
      run: |
        mv dist/CursorToolFree.exe dist/CursorToolFree-Windows.exe
        
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./dist/CursorToolFree-Windows.exe

  build-macos:
    needs: create-release
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - arch: universal2
            name: Universal
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # 跳过requirements_browser.txt以避免psutil的universal2兼容性问题
        # DrissionPage和pyperclip是可选的浏览器功能，核心功能不受影响
        pip install pyinstaller
    
    - name: Verify macOS icon
      run: |
        echo "✅ 使用项目中的icon.icns文件"
        ls -la icon.icns
        
    - name: Build macOS executable  
      run: |
        pyinstaller --onedir --windowed --name "CursorToolFree" main.py \
          --add-data "src:src" \
          --add-data "resources:resources" \
          --hidden-import PyQt6 \
          --icon=icon.icns \
          --osx-bundle-identifier com.cursor.toolfree \
          --target-arch ${{ matrix.arch }}
    
    - name: Create DMG
      run: |
        # 安装create-dmg工具
        brew install create-dmg
        
        # 创建DMG文件
        create-dmg \
          --volname "Cursor Tool Free" \
          --volicon "icon.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "CursorToolFree.app" 150 200 \
          --hide-extension "CursorToolFree.app" \
          --app-drop-link 450 200 \
          "CursorToolFree-macOS-${{ matrix.name }}.dmg" \
          "dist/"
        
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./CursorToolFree-macOS-${{ matrix.name }}.dmg

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fuse
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
    
    - name: Build Linux executable
      run: |
        pyinstaller --onefile --windowed --name "CursorToolFree" main.py \
          --add-data "src:src" \
          --add-data "resources:resources" \
          --hidden-import PyQt6 \
          --icon=icon.png
    
    - name: Upload Linux executable
      run: |
        mv dist/CursorToolFree dist/CursorToolFree-Linux
        
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./dist/CursorToolFree-Linux
