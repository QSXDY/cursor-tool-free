# 自动化发布工作流
# 当推送版本标签时自动构建和发布跨平台可执行文件

name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # 匹配 v1.0.0、v1.2.3 等版本标签

permissions:
  contents: write  # 需要写权限来创建release

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
    - name: Get version from tag
      id: get_version
      run: |
        echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: 'Cursor Tool Free ${{ steps.get_version.outputs.tag_name }}'
        body: |
          🎉 **Cursor Tool Free ${{ steps.get_version.outputs.tag_name }}** 发布！
          
          ## 📦 下载链接
          
          - 🪟 **Windows**: CursorToolFree-Windows.exe
          - 🍎 **macOS (Apple Silicon)**: CursorToolFree-macOS-AppleSilicon.dmg
          - 🍎 **macOS (Intel)**: CursorToolFree-macOS-Intel.dmg
          - 🐧 **Linux**: CursorToolFree-Linux.AppImage（双击运行，通杀所有Linux发行版）
          
          ## ✨ 主要功能
          
          - 🔐 专业的Cursor账号管理系统
          - 📱 现代化用户界面
          - 🌍 完整跨平台支持
          - 🛡️ 账号安全与隐私保护
          - 🌐 浏览器Cookie导入支持
          
          ## 🚀 快速开始
          
          **Windows / Linux:**
          1. 下载对应平台的可执行文件
          2. 双击运行
          
          **macOS:**
          1. 下载对应芯片的DMG文件（M系列用Apple Silicon，Intel用Intel）
          2. 打开DMG，拖拽应用到Applications文件夹
          3. 🔑 **首次打开**：右键点击应用 → 选择"打开" → 确认
          4. 之后可正常双击使用
          
          💡 详细的macOS使用说明请查看 [MACOS_USER_GUIDE.md](https://github.com/QSXDY/cursor-tool-free/blob/main/MACOS_USER_GUIDE.md)
          
          ---
          
          💡 如需源码安装或二次开发，请查看 [README.md](https://github.com/QSXDY/cursor-tool-free#readme)
        draft: false
        prerelease: false

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --name "CursorToolFree" main.py --add-data "src;src" --add-data "resources;resources" --hidden-import PyQt6 --icon=icon.ico
    
    - name: Upload Windows executable
      run: |
        mv dist/CursorToolFree.exe dist/CursorToolFree-Windows.exe
        
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./dist/CursorToolFree-Windows.exe

  build-macos:
    needs: create-release
    strategy:
      matrix:
        include:
          - arch: arm64
            name: AppleSilicon
            runs-on: macos-latest
          - arch: x86_64
            name: Intel
            runs-on: macos-13  # 使用 Intel 构建环境
    runs-on: ${{ matrix.runs-on }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
    
    - name: Verify macOS icon
      run: |
        echo "✅ 使用项目中的icon.icns文件"
        ls -la icon.icns
        
    - name: Build macOS executable with spec file
      run: |
        # 使用spec文件构建，支持BUNDLE配置
        pyinstaller CursorToolFree.spec --clean --noconfirm
    
    - name: Sign macOS app (ad-hoc)
      run: |
        # Ad-hoc签名，无需开发者证书
        echo "🔏 执行ad-hoc签名..."
        codesign --force --deep --sign - "dist/CursorToolFree.app"
        
        # 验证签名
        echo "🔍 验证签名..."
        codesign --verify --deep --strict --verbose=2 "dist/CursorToolFree.app" || echo "⚠️ 签名验证警告（可忽略）"
    
    - name: Create DMG
      run: |
        # 安装create-dmg工具
        brew install create-dmg
        
        # 创建DMG文件
        create-dmg \
          --volname "Cursor Tool Free" \
          --volicon "icon.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "CursorToolFree.app" 150 200 \
          --hide-extension "CursorToolFree.app" \
          --app-drop-link 450 200 \
          "CursorToolFree-macOS-${{ matrix.name }}.dmg" \
          "dist/"
        
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./CursorToolFree-macOS-${{ matrix.name }}.dmg

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fuse
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
    
    - name: Build Linux AppImage
      run: |
        # 使用 PyInstaller 生成可执行文件
        pyinstaller CursorToolFree.spec --clean --noconfirm
        
        # 下载 AppImage 工具
        wget -O appimagetool-x86_64.AppImage https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        
        # 创建 AppImage 目录结构
        mkdir -p CursorToolFree.AppDir/usr/bin CursorToolFree.AppDir/usr/share/applications CursorToolFree.AppDir/usr/share/icons/hicolor/512x512/apps
        cp dist/CursorToolFree CursorToolFree.AppDir/usr/bin/
        cp -r resources CursorToolFree.AppDir/usr/share/
        cp icon.png CursorToolFree.AppDir/usr/share/icons/hicolor/512x512/apps/cursor-tool-free.png
        cp icon.png CursorToolFree.AppDir/cursor-tool-free.png
        
        # 创建 .desktop 文件
        cat > CursorToolFree.AppDir/cursor-tool-free.desktop << 'DESKTOP_EOF'
        [Desktop Entry]
        Type=Application
        Name=Cursor Tool Free
        Comment=Cursor账号管理工具 - 免费精简版
        Exec=CursorToolFree
        Icon=cursor-tool-free
        Categories=Development;
        Terminal=false
        StartupWMClass=CursorToolFree
        Keywords=cursor;account;manager;开发;账号;管理;
        GenericName=Cursor Account Manager
        X-AppImage-Version=1.0.0
        DESKTOP_EOF
        
        # 创建 AppRun 脚本
        cat > CursorToolFree.AppDir/AppRun << 'APPRUN_EOF'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${0}")")"
        export QT_QPA_PLATFORM="${QT_QPA_PLATFORM:-xcb}"
        exec "${HERE}/usr/bin/CursorToolFree" "$@"
        APPRUN_EOF
        chmod +x CursorToolFree.AppDir/AppRun
        
        # 复制 .desktop 文件并创建 .DirIcon 符号链接
        cp CursorToolFree.AppDir/cursor-tool-free.desktop CursorToolFree.AppDir/usr/share/applications/
        cd CursorToolFree.AppDir && ln -sf cursor-tool-free.png .DirIcon && cd ..
        
        # 生成 AppImage
        ARCH=x86_64 ./appimagetool-x86_64.AppImage CursorToolFree.AppDir CursorToolFree-Linux.AppImage
    
    - name: Upload Linux AppImage
      run: |
        # AppImage 已经是最终文件，无需重命名
        
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: ./CursorToolFree-Linux.AppImage
