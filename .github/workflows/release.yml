# è‡ªåŠ¨åŒ–å‘å¸ƒå·¥ä½œæµ
# å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒè·¨å¹³å°å¯æ‰§è¡Œæ–‡ä»¶

name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0ã€v1.2.3 ç­‰ç‰ˆæœ¬æ ‡ç­¾

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºrelease

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
    - name: Get version from tag
      id: get_version
      run: |
        echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        release_name: 'Cursor Tool Free ${{ steps.get_version.outputs.tag_name }}'
        body: |
          ðŸŽ‰ **Cursor Tool Free ${{ steps.get_version.outputs.tag_name }}** å‘å¸ƒï¼
          
          ## ðŸ“¦ ä¸‹è½½é“¾æŽ¥
          
          - ðŸªŸ **Windows**: CursorToolFree-Windows.exe
          - ðŸŽ **macOS**: CursorToolFree-macOS.dmg  
          - ðŸ§ **Linux**: CursorToolFree-Linux.AppImage
          
          ## âœ¨ ä¸»è¦åŠŸèƒ½
          
          - ðŸ” ä¸“ä¸šçš„Cursorè´¦å·ç®¡ç†ç³»ç»Ÿ
          - ðŸ“± çŽ°ä»£åŒ–ç”¨æˆ·ç•Œé¢
          - ðŸŒ å®Œæ•´è·¨å¹³å°æ”¯æŒ
          - ðŸ›¡ï¸ è´¦å·å®‰å…¨ä¸Žéšç§ä¿æŠ¤
          - ðŸŒ æµè§ˆå™¨Cookieå¯¼å…¥æ”¯æŒ
          
          ## ðŸš€ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
          2. åŒå‡»è¿è¡Œï¼ˆé¦–æ¬¡å¯åŠ¨ä¼šè¦æ±‚è®¾ç½®Cursorè·¯å¾„ï¼‰
          3. å¼€å§‹ç®¡ç†ä½ çš„Cursorè´¦å·
          
          ---
          
          ðŸ’¡ å¦‚éœ€æºç å®‰è£…æˆ–äºŒæ¬¡å¼€å‘ï¼Œè¯·æŸ¥çœ‹ [README.md](https://github.com/QSXDY/cursor-tool-free#readme)
        draft: false
        prerelease: false

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --name "CursorToolFree" main.py ^
          --add-data "src;src" ^
          --hidden-import PyQt6 ^
          --icon=icon.ico ^
          --version-file=version_info.txt
    
    - name: Upload Windows executable
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./dist/CursorToolFree.exe
        asset_name: CursorToolFree-Windows.exe
        asset_content_type: application/octet-stream

  build-macos:
    needs: create-release
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
        # å®‰è£…macOSæ‰“åŒ…å·¥å…·
        brew install create-dmg
    
    - name: Build macOS app bundle
      run: |
        pyinstaller --onefile --windowed --name "CursorToolFree" main.py \
          --add-data "src:src" \
          --hidden-import PyQt6 \
          --osx-bundle-identifier com.cursor.toolfree
    
    - name: Create DMG
      run: |
        create-dmg \
          --volname "Cursor Tool Free" \
          --volicon "icon.icns" \
          --window-pos 200 120 \
          --window-size 600 300 \
          --icon-size 100 \
          --icon "CursorToolFree.app" 175 120 \
          --hide-extension "CursorToolFree.app" \
          --app-drop-link 425 120 \
          "CursorToolFree.dmg" \
          "dist/"
    
    - name: Upload macOS DMG
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./CursorToolFree.dmg
        asset_name: CursorToolFree-macOS.dmg
        asset_content_type: application/octet-stream

  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          fuse \
          libfuse2 \
          libegl1-mesa \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements_browser.txt
        pip install pyinstaller
    
    - name: Build Linux executable
      run: |
        pyinstaller --onefile --windowed --name "CursorToolFree" main.py \
          --add-data "src:src" \
          --hidden-import PyQt6
    
    - name: Download AppImage tools
      run: |
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
    
    - name: Create AppImage structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        cp dist/CursorToolFree AppDir/usr/bin/
        
        # åˆ›å»º.desktopæ–‡ä»¶
        cat > AppDir/CursorToolFree.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=Cursor Tool Free
        Comment=Cursorè´¦å·ç®¡ç†å·¥å…·
        Exec=CursorToolFree
        Icon=cursor-tool-free
        Categories=Development;Utility;
        EOF
        
        # å¤åˆ¶desktopæ–‡ä»¶åˆ°æ ‡å‡†ä½ç½®
        cp AppDir/CursorToolFree.desktop AppDir/usr/share/applications/
        
        # åˆ›å»ºç®€å•å›¾æ ‡ï¼ˆå¦‚æžœæ²¡æœ‰icon.pngï¼‰
        touch AppDir/usr/share/icons/hicolor/256x256/apps/cursor-tool-free.png
    
    - name: Build AppImage
      run: |
        ./appimagetool-x86_64.AppImage AppDir CursorToolFree-Linux.AppImage
        chmod +x CursorToolFree-Linux.AppImage
    
    - name: Upload Linux AppImage
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./CursorToolFree-Linux.AppImage
        asset_name: CursorToolFree-Linux.AppImage
        asset_content_type: application/octet-stream
